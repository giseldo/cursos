# Gerenciamento de Pacotes com npm/Yarn

:::info
Criado por Kleber Galv√£o.
:::

Bem-vindo √† terceira aula do curso **Node.js do B√°sico ao Avan√ßado**! Esta aula foca em um aspecto essencial do desenvolvimento com Node.js: o **gerenciamento de pacotes** usando **npm** (Node Package Manager) e **Yarn**. Vamos explorar como esses gerenciadores de pacotes facilitam a instala√ß√£o, configura√ß√£o e manuten√ß√£o de depend√™ncias em projetos Node.js, com √™nfase na estrutura do arquivo `package.json`, gerenciamento de depend√™ncias e cria√ß√£o de scripts personalizados. Al√©m disso, voc√™ aprender√° a instalar e usar a biblioteca `lodash` em um exemplo pr√°tico, aplicando conceitos reais de desenvolvimento.

O objetivo √© que voc√™ compreenda como gerenciar pacotes de forma eficiente, organize depend√™ncias e automatize tarefas com scripts, preparando-se para projetos escal√°veis. O material √© dividido em duas partes: uma **teoria** detalhada sobre npm, Yarn e `package.json`, seguida de um **exemplo pr√°tico** que demonstra a integra√ß√£o da biblioteca `lodash` em um projeto Node.js.

---

## Teoria: Estrutura do `package.json`, Depend√™ncias e Scripts npm/Yarn

### 1. Introdu√ß√£o ao Gerenciamento de Pacotes

No desenvolvimento Node.js, **pacotes** s√£o bibliotecas ou m√≥dulos reutiliz√°veis que adicionam funcionalidades ao seu projeto, como manipula√ß√£o de dados, cria√ß√£o de APIs ou automa√ß√£o de tarefas. O **npm** (Node Package Manager) √© a ferramenta padr√£o do Node.js para gerenciar esses pacotes, enquanto o **Yarn** √© uma alternativa popular que oferece melhor performance e funcionalidades adicionais. Ambos permitem instalar, atualizar e remover pacotes, al√©m de gerenciar depend√™ncias e executar scripts personalizados.

O **npm** √© instalado automaticamente com o Node.js e d√° acesso ao maior reposit√≥rio de pacotes open-source do mundo, o **npm registry** (npmjs.com), com milh√µes de pacotes dispon√≠veis, como `lodash`, `express` e `jest`. O **Yarn**, desenvolvido pelo Facebook, √© compat√≠vel com o npm registry, mas introduz recursos como instala√ß√£o offline e maior determinismo.

O cora√ß√£o do gerenciamento de pacotes √© o arquivo **`package.json`**, que define as configura√ß√µes do projeto, depend√™ncias e scripts. Vamos explorar cada aspecto em detalhes.

### 2. O Arquivo `package.json`

O `package.json` √© um arquivo JSON que serve como o manifesto do seu projeto Node.js. Ele cont√©m metadados, depend√™ncias e scripts, garantindo que o projeto seja port√°til e reproduz√≠vel em diferentes ambientes. O arquivo √© criado automaticamente ao executar `npm init` ou `yarn init`.

#### 2.1. Estrutura do `package.json`

Aqui est√° um exemplo t√≠pico de `package.json`:

```json
{
  "name": "meu-projeto",
  "version": "1.0.0",
  "description": "Um projeto Node.js de exemplo",
  "main": "index.js",
  "type": "module",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js",
    "test": "jest"
  },
  "keywords": ["node", "javascript"],
  "author": "Seu Nome",
  "license": "MIT",
  "dependencies": {
    "lodash": "^4.17.21",
    "express": "^4.18.2"
  },
  "devDependencies": {
    "nodemon": "^3.0.1",
    "jest": "^29.7.0"
  }
}
```

**Campos principais**:

- **`name`**: Nome do projeto ou pacote. Deve ser √∫nico se publicado no npm registry (ex.: `"meu-projeto"`).
- **`version`**: Vers√£o do projeto, seguindo o padr√£o **SemVer** (Semantic Versioning, ex.: `1.0.0`).
- **`description`**: Breve descri√ß√£o do projeto, √∫til para documenta√ß√£o e publica√ß√£o.
- **`main`**: Arquivo de entrada do projeto (ex.: `index.js`).
- **`type`**: Define o sistema de m√≥dulos (`"module"` para ES Modules ou `"commonjs"` para CommonJS).
- **`scripts`**: Comandos personalizados executados com `npm run <script>` ou `yarn <script>`.
- **`keywords`**: Palavras-chave para facilitar a busca no npm registry.
- **`author`**: Nome do autor (ex.: `"Seu Nome <seu.email@example.com>"`).
- **`license`**: Licen√ßa do projeto (ex.: `"MIT"`, `"ISC"`).
- **`dependencies`**: Pacotes necess√°rios para a execu√ß√£o do projeto.
- **`devDependencies`**: Pacotes usados apenas em desenvolvimento ou testes.

#### 2.2. Semantic Versioning (SemVer)

As vers√µes de pacotes no `package.json` seguem o padr√£o **SemVer**: `MAJOR.MINOR.PATCH`. Exemplos:

- `1.0.0`: Vers√£o inicial.
- `1.1.0`: Adiciona novas funcionalidades (MINOR), mas mant√©m compatibilidade.
- `2.0.0`: Introduz mudan√ßas incompat√≠veis (MAJOR).
- `1.0.1`: Corrige bugs (PATCH) sem alterar funcionalidades.

**S√≠mbolos de vers√£o**:
- `^4.17.21`: Permite atualiza√ß√µes de MINOR e PATCH (ex.: `4.x.x`).
- `~4.17.21`: Permite apenas atualiza√ß√µes de PATCH (ex.: `4.17.x`).
- `4.17.21`: Vers√£o exata, sem atualiza√ß√µes autom√°ticas.

#### 2.3. Criando o `package.json`

- **Com npm**:
  ```bash
  npm init
  ```
  Responda √†s perguntas interativas (nome, vers√£o, etc.) ou use:
  ```bash
  npm init -y
  ```
  para criar com valores padr√£o.

- **Com Yarn**:
  ```bash
  yarn init
  ```
  ou:
  ```bash
  yarn init -y
  ```

### 3. Gerenciamento de Depend√™ncias

Depend√™ncias s√£o pacotes externos listados no `package.json`. Elas s√£o divididas em dois tipos:

- **`dependencies`**: Pacotes necess√°rios para a execu√ß√£o do projeto em produ√ß√£o (ex.: `express`, `lodash`).
- **`devDependencies`**: Pacotes usados apenas em desenvolvimento ou testes (ex.: `nodemon`, `jest`).

#### 3.1. Instalando Depend√™ncias

- **Com npm**:
  ```bash
  npm install lodash
  # Ou, abreviado:
  npm i lodash
  ```
  Para depend√™ncias de desenvolvimento:
  ```bash
  npm install --save-dev nodemon
  # Ou:
  npm i -D nodemon
  ```

- **Com Yarn**:
  ```bash
  yarn add lodash
  ```
  Para depend√™ncias de desenvolvimento:
  ```bash
  yarn add --dev nodemon
  ```

Ao instalar, o pacote √© baixado para a pasta `node_modules`, e a vers√£o √© registrada no `package.json`.

#### 3.2. O Arquivo `package-lock.json` (npm) ou `yarn.lock` (Yarn)

- **`package-lock.json`**: Gerado pelo npm, ele trava as vers√µes exatas de todas as depend√™ncias (incluindo subdepend√™ncias), garantindo consist√™ncia entre ambientes.
- **`yarn.lock`**: Equivalente no Yarn, com o mesmo prop√≥sito.

**Boas pr√°ticas**:
- Sempre versione esses arquivos no Git para garantir builds reproduz√≠veis.
- Evite editar manualmente; use comandos como `npm install` ou `yarn add`.

#### 3.3. Atualizando Depend√™ncias

- **Com npm**:
  ```bash
  npm update
  ```
  Atualiza depend√™ncias dentro das faixas permitidas no `package.json`.
  Para verificar pacotes desatualizados:
  ```bash
  npm outdated
  ```

- **Com Yarn**:
  ```bash
  yarn upgrade
  ```
  Para verificar pacotes desatualizados:
  ```bash
  yarn outdated
  ```

#### 3.4. Removendo Depend√™ncias

- **Com npm**:
  ```bash
  npm uninstall lodash
  ```

- **Com Yarn**:
  ```bash
  yarn remove lodash
  ```

#### 3.5. Depend√™ncias Globais

Pacotes globais s√£o instalados no sistema e podem ser usados em qualquer projeto:

- **npm**:
  ```bash
  npm install -g nodemon
  ```

- **Yarn**:
  ```bash
  yarn global add nodemon
  ```

**Nota**: Evite depend√™ncias globais em projetos reproduz√≠veis, pois elas podem causar inconsist√™ncias. Prefira depend√™ncias locais.

### 4. Scripts no `package.json`

O campo `scripts` no `package.json` permite definir comandos personalizados para automatizar tarefas, como iniciar o servidor, rodar testes ou formatar c√≥digo.

#### 4.1. Exemplo de Scripts

```json
"scripts": {
  "start": "node index.js",
  "dev": "nodemon index.js",
  "test": "jest",
  "lint": "eslint .",
  "build": "tsc"
}
```

- **`start`**: Executado com `npm start` ou `yarn start`. Usado para iniciar a aplica√ß√£o em produ√ß√£o.
- **`dev`**: Executado com `npm run dev` ou `yarn dev`. Usado para desenvolvimento com ferramentas como `nodemon`.
- **`test`**: Executado com `npm test` ou `yarn test`. Usado para rodar testes.
- **`lint`**: Verifica a qualidade do c√≥digo com ESLint.
- **`build`**: Compila TypeScript (se aplic√°vel).

#### 4.2. Executando Scripts

- **npm**:
  ```bash
  npm start
  npm run dev
  ```

- **Yarn**:
  ```bash
  yarn start
  yarn dev
  ```

**Nota**: `start` e `test` n√£o exigem `run`, mas outros scripts sim.

#### 4.3. Scripts Pr√© e P√≥s

Voc√™ pode definir scripts que rodam automaticamente antes (`pre`) ou depois (`post`) de outro script:

```json
"scripts": {
  "prestart": "npm run lint",
  "start": "node index.js",
  "poststart": "echo 'Servidor iniciado!'"
}
```

Executar `npm start` rodar√° `prestart`, `start` e `poststart` na ordem.

### 5. npm vs. Yarn: Diferen√ßas e Quando Usar

Embora npm e Yarn sejam semelhantes, eles t√™m diferen√ßas importantes:

| Caracter√≠stica               | npm                                    | Yarn                                  |
|------------------------------|----------------------------------------|---------------------------------------|
| **Performance**              | Melhorou nas vers√µes recentes (v10+)   | Geralmente mais r√°pido                |
| **Lockfile**                 | `package-lock.json`                    | `yarn.lock`                           |
| **Instala√ß√£o Offline**       | Suporte parcial                        | Cache offline robusto                 |
| **Determinismo**             | Bom, mas Yarn √© mais consistente       | Altamente determin√≠stico              |
| **Comandos**                 | `npm install`, `npm run`               | `yarn add`, `yarn`                    |
| **Workspaces**               | Suporte b√°sico                         | Suporte avan√ßado para monorepos       |
| **Popularidade em 2025**     | Padr√£o, amplamente usado               | Preferido em projetos grandes         |

#### 5.1. Quando Usar npm?

- Projetos simples ou iniciantes, onde a simplicidade √© prioridade.
- Quando voc√™ j√° usa o npm registry e n√£o precisa de recursos avan√ßados.
- Projetos que n√£o requerem monorepos ou instala√ß√£o offline.

#### 5.2. Quando Usar Yarn?

- Projetos grandes ou monorepos (ex.: m√∫ltiplos pacotes em um reposit√≥rio).
- Quando voc√™ precisa de instala√ß√£o r√°pida e determin√≠stica.
- Projetos que exigem cache offline ou suporte avan√ßado a workspaces.
- Equipes que preferem uma interface de comando mais amig√°vel.

Em 2025, ambos s√£o excelentes escolhas, mas **npm** √© suficiente para a maioria dos projetos devido √†s melhorias recentes, enquanto **Yarn** √© preferido em projetos complexos.

### 6. Boas Pr√°ticas para Gerenciamento de Pacotes

1. **Mantenha o `package.json` Limpo**:
   - Remova depend√™ncias n√£o utilizadas com `npm prune` ou `yarn autoclean`.
   - Use nomes descritivos e atualize metadados (ex.: `description`, `author`).

2. **Versione o Lockfile**:
   - Inclua `package-lock.json` ou `yarn.lock` no Git para builds consistentes.

3. **Evite Depend√™ncias Desnecess√°rias**:
   - Verifique se um pacote √© realmente necess√°rio antes de instal√°-lo.
   - Use ferramentas como `depcheck` para identificar depend√™ncias n√£o usadas.

4. **Atualize Regularmente**:
   - Use `npm outdated` ou `yarn outdated` para identificar pacotes desatualizados.
   - Teste atualiza√ß√µes em um ambiente de desenvolvimento antes de aplicar em produ√ß√£o.

5. **Use Scripts para Automa√ß√£o**:
   - Crie scripts para tarefas comuns (ex.: linting, testes, build).
   - Combine ferramentas como `nodemon`, `eslint` e `jest` para produtividade.

6. **Seguran√ßa**:
   - Use `npm audit` ou `yarn audit` para identificar vulnerabilidades:
     ```bash
     npm audit
     npm audit fix
     ```
   - Monitore pacotes com ferramentas como Dependabot (GitHub).

---

## Exemplo Pr√°tico: Instalar e Usar a Biblioteca `lodash`

Neste exemplo pr√°tico, vamos criar um projeto Node.js, instalar a biblioteca **lodash** (uma biblioteca utilit√°ria popular para manipula√ß√£o de arrays, objetos e strings), e us√°-la para realizar opera√ß√µes comuns, como agrupamento e filtragem de dados. Implementaremos o exemplo com **npm** e mostraremos como replicar com **Yarn**.

### Objetivo do Exemplo

- Configurar um projeto Node.js com `package.json`.
- Instalar a biblioteca `lodash` como depend√™ncia.
- Criar um script que usa fun√ß√µes do `lodash` para manipular uma lista de objetos.
- Executar o projeto com scripts personalizados.

### Passo 1: Configurar o Projeto

1. Crie uma nova pasta para o projeto:
   ```bash
   mkdir lodash-exemplo
   cd lodash-exemplo
   npm init -y
   ```

2. O `package.json` ser√° criado:
   ```json
   {
     "name": "lodash-exemplo",
     "version": "1.0.0",
     "description": "",
     "main": "index.js",
     "scripts": {
       "test": "echo \"Error: no test specified\" && exit 1"
     },
     "keywords": [],
     "author": "",
     "license": "ISC"
   }
   ```

3. (Opcional) Para usar ES Modules, adicione:
   ```json
   "type": "module"
   ```

4. Instale o `nodemon` como depend√™ncia de desenvolvimento:
   ```bash
   npm install --save-dev nodemon
   ```
   Atualize os scripts no `package.json`:
   ```json
   "scripts": {
     "start": "node index.js",
     "dev": "nodemon index.js"
   }
   ```

### Passo 2: Instalar a Biblioteca `lodash`

1. Instale o `lodash` como depend√™ncia de produ√ß√£o:
   ```bash
   npm install lodash
   ```

2. Verifique o `package.json` atualizado:
   ```json
   {
     "name": "lodash-exemplo",
     "version": "1.0.0",
     "description": "",
     "main": "index.js",
     "type": "module",
     "scripts": {
       "start": "node index.js",
       "dev": "nodemon index.js"
     },
     "keywords": [],
     "author": "",
     "license": "ISC",
     "dependencies": {
       "lodash": "^4.17.21"
     },
     "devDependencies": {
       "nodemon": "^3.0.1"
     }
   }
   ```

3. O `package-lock.json` tamb√©m ser√° gerado, travando as vers√µes exatas.

### Passo 3: Criar o Script com `lodash`

1. Crie um arquivo `index.js` (ou `index.mjs` para ES Modules):
   ```javascript
   // index.mjs (para ES Modules)
   import _ from 'lodash';

   // Lista de exemplo: dados de usu√°rios
   const usuarios = [
     { id: 1, nome: 'Alice', idade: 25, cidade: 'S√£o Paulo' },
     { id: 2, nome: 'Bob', idade: 30, cidade: 'Rio de Janeiro' },
     { id: 3, nome: 'Charlie', idade: 25, cidade: 'S√£o Paulo' },
     { id: 4, nome: 'David', idade: 35, cidade: 'Belo Horizonte' }
   ];

   // Usando lodash para manipular dados
   // 1. Agrupar usu√°rios por cidade
   const porCidade = _.groupBy(usuarios, 'cidade');
   console.log('Usu√°rios por cidade:', porCidade);

   // 2. Filtrar usu√°rios com idade 25
   const idade25 = _.filter(usuarios, { idade: 25 });
   console.log('Usu√°rios com 25 anos:', idade25);

   // 3. Mapear apenas os nomes
   const nomes = _.map(usuarios, 'nome');
   console.log('Nomes dos usu√°rios:', nomes);

   // 4. Encontrar usu√°rio por ID
   const usuarioId2 = _.find(usuarios, { id: 2 });
   console.log('Usu√°rio com ID 2:', usuarioId2);
   ```

   **Para CommonJS** (se n√£o usar `"type": "module"`):
   ```javascript
   // index.js
   const _ = require('lodash');

   // Mesmo c√≥digo acima, apenas com require em vez de import
   const usuarios = [
     { id: 1, nome: 'Alice', idade: 25, cidade: 'S√£o Paulo' },
     { id: 2, nome: 'Bob', idade: 30, cidade: 'Rio de Janeiro' },
     { id: 3, nome: 'Charlie', idade: 25, cidade: 'S√£o Paulo' },
     { id: 4, nome: 'David', idade: 35, cidade: 'Belo Horizonte' }
   ];

   const porCidade = _.groupBy(usuarios, 'cidade');
   console.log('Usu√°rios por cidade:', porCidade);

   const idade25 = _.filter(usuarios, { idade: 25 });
   console.log('Usu√°rios com 25 anos:', idade25);

   const nomes = _.map(usuarios, 'nome');
   console.log('Nomes dos usu√°rios:', nomes);

   const usuarioId2 = _.find(usuarios, { id: 2 });
   console.log('Usu√°rio com ID 2:', usuarioId2);
   ```

2. **Explica√ß√£o do C√≥digo**:
   - Importamos o `lodash` (usando `_` por conven√ß√£o).
   - Criamos uma lista de objetos `usuarios` para simular dados reais.
   - Usamos fun√ß√µes do `lodash`:
     - `_.groupBy`: Agrupa objetos por uma propriedade (ex.: `cidade`).
     - `_.filter`: Filtra objetos com base em crit√©rios.
     - `_.map`: Extrai uma propriedade de cada objeto.
     - `_.find`: Busca o primeiro objeto que corresponde ao crit√©rio.

### Passo 4: Executar o Projeto

1. Execute o script:
   ```bash
   npm start
   ```
   Ou, para desenvolvimento com rein√≠cio autom√°tico:
   ```bash
   npm run dev
   ```

2. **Sa√≠da esperada**:
   ```json
   Usu√°rios por cidade: {
     'S√£o Paulo': [
       { id: 1, nome: 'Alice', idade: 25, cidade: 'S√£o Paulo' },
       { id: 3, nome: 'Charlie', idade: 25, cidade: 'S√£o Paulo' }
     ],
     'Rio de Janeiro': [
       { id: 2, nome: 'Bob', idade: 30, cidade: 'Rio de Janeiro' }
     ],
     'Belo Horizonte': [
       { id: 4, nome: 'David', idade: 35, cidade: 'Belo Horizonte' }
     ]
   }
   Usu√°rios com 25 anos: [
     { id: 1, nome: 'Alice', idade: 25, cidade: 'S√£o Paulo' },
     { id: 3, nome: 'Charlie', idade: 25, cidade: 'S√£o Paulo' }
   ]
   Nomes dos usu√°rios: ['Alice', 'Bob', 'Charlie', 'David']
   Usu√°rio com ID 2: { id: 2, nome: 'Bob', idade: 30, cidade: 'Rio de Janeiro' }
   ```

### Passo 5: Replicando com Yarn

1. Remova o `node_modules` e `package-lock.json`:
   ```bash
   rm -rf node_modules package-lock.json
   ```

2. Instale o Yarn (se necess√°rio):
   ```bash
   npm install -g yarn
   ```

3. Instale as depend√™ncias com Yarn:
   ```bash
   yarn add lodash
   yarn add --dev nodemon
   ```

4. Verifique o `yarn.lock` gerado e execute:
   ```bash
   yarn start
   ```
   Ou:
   ```bash
   yarn dev
   ```

5. A sa√≠da ser√° id√™ntica, mas o Yarn cria um `yarn.lock` em vez de `package-lock.json`.

### Passo 6: Depura√ß√£o e Boas Pr√°ticas

1. **Depura√ß√£o**:
   - Use o VS Code para depurar:
     - Crie um `launch.json`:
       ```json
       {
         "version": "0.2.0",
         "configurations": [
           {
             "type": "node",
             "request": "launch",
             "name": "Launch Program",
             "program": "${workspaceFolder}/index.js"
           }
         ]
       }
       ```
     - Adicione breakpoints e execute com `F5`.

2. **Verifique Depend√™ncias**:
   - Use `npm list` ou `yarn list` para ver a √°rvore de depend√™ncias.
   - Verifique vulnerabilidades:
     ```bash
     npm audit
     yarn audit
     ```

3. **Versionamento**:
   - Adicione os arquivos ao Git:
     ```bash
     git init
     git add .
     git commit -m "Projeto com lodash usando npm/yarn"
     ```

4. **Evite `node_modules` no Git**:
   - Crie um `.gitignore`:
     ```
     node_modules/
     ```

---

## Conclus√£o

Nesta aula, voc√™ aprendeu:
- **Estrutura do `package.json`**: Metadados, depend√™ncias, scripts e SemVer.
- **Gerenciamento de Depend√™ncias**: Como instalar, atualizar e remover pacotes com npm e Yarn.
- **Scripts Personalizados**: Automatiza√ß√£o de tarefas com o campo `scripts`.
- **npm vs. Yarn**: Diferen√ßas, vantagens e casos de uso.
- **Exemplo Pr√°tico**: Instalou e usou a biblioteca `lodash` para manipular dados em um projeto Node.js.

Esses conceitos s√£o fundamentais para gerenciar projetos Node.js de forma eficiente e escal√°vel. Nos pr√≥ximos m√≥dulos, voc√™ aplicar√° esse conhecimento para construir APIs com Express e manipular arquivos com o m√≥dulo `fs`.

### Pr√≥ximos Passos

- Experimente instalar outras bibliotecas (ex.: `moment`, `axios`) e criar scripts para us√°-las.
- Explore a documenta√ß√£o do npm: [npmjs.com](https://npmjs.com) e Yarn: [yarnpkg.com](https://yarnpkg.com).
- Prepare-se para o pr√≥ximo m√≥dulo, onde abordaremos o **Projeto Pr√°tico: Servidor HTTP Simples**.

Se tiver d√∫vidas ou quiser mais exemplos, √© s√≥ pedir! üöÄ
